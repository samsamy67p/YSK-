<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ماسح الباركود - شيخ العرب</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    :root {
      --bg:#0b0b0f; --fg:#e7e7ea; --muted:#9aa0a6; --primary:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --card:#121218; --glass: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 70% -20%, rgba(34,211,238,.15), transparent 55%) , var(--bg);
      color:var(--fg);
    }

    /* Top bar */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; background:linear-gradient(to bottom, rgba(0,0,0,.5), transparent);
      z-index:30
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand i{font-size:26px;color:var(--primary)}
    .brand b{font-weight:700; letter-spacing:.3px}

    /* Reader area */
    #reader-wrap{position:relative; width:100vw; height:100vh; overflow:hidden}
    #reader{position:absolute; inset:0; width:100%; height:100%}

    /* Overlay UI */
    .overlay{
      position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:20;
    }
    .status{
      display:flex; flex-direction:column; align-items:center; gap:12px;
      background:var(--glass); padding:18px 20px; border:1px solid rgba(255,255,255,.08);
      border-radius:16px; backdrop-filter: blur(8px); box-shadow:0 10px 30px rgba(0,0,0,.35);
      max-width:90vw; text-align:center
    }
    .status .icon{font-size:42px; line-height:1}
    .status .title{font-weight:700; font-size:18px}
    .status .sub{color:var(--muted); font-size:14px}
    .status.ready .icon{color:#60a5fa}
    .status.scanning .icon{color:var(--primary); animation:pulse 1.6s infinite}
    .status.success .icon{color:var(--ok)}
    .status.error .icon{color:var(--err)}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    /* Framing corners */
    .frame{
      position:absolute; inset:12% 10%; border-radius:18px; border:2px dashed rgba(255,255,255,.25); z-index:10;
    }
    .corner{position:absolute; width:36px; height:36px; border:3px solid var(--primary)}
    .corner.tl{top:-3px; inset-inline-start:-3px; border-bottom:none; border-inline-end:none}
    .corner.tr{top:-3px; inset-inline-end:-3px; border-bottom:none; border-inline-start:none}
    .corner.bl{bottom:-3px; inset-inline-start:-3px; border-top:none; border-inline-end:none}
    .corner.br{bottom:-3px; inset-inline-end:-3px; border-top:none; border-inline-start:none}

    /* Bottom controls */
    .bottombar{
      position:fixed; inset-inline:0; bottom:0; display:flex; gap:10px; justify-content:center; padding:12px;
      background:linear-gradient(to top, rgba(0,0,0,.55), transparent); z-index:30
    }
    .btn{
      pointer-events:auto; display:inline-flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.08);
      background:var(--card); color:var(--fg); padding:10px 14px; border-radius:14px; font-weight:600; cursor:pointer;
      transition:.2s transform,.2s opacity,.2s background;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg, #0ea5e9, #22d3ee); border-color:transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Hide status on very small heights to keep camera clear */
    @media (max-height:640px){
      .overlay{align-items:flex-start; padding-top:76px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <i class="ri-qr-scan-2-line"></i>
      <b>ماسح الباركود</b>
    </div>
    <div id="connBadge" class="btn" style="pointer-events:none;opacity:.85">
      <i class="ri-cloud-line"></i><span>الاتصال: غير معروف</span>
    </div>
  </div>

  <div id="reader-wrap">
    <div id="reader"></div>

    <div class="frame" aria-hidden="true">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
    </div>

    <div class="overlay">
      <div id="status" class="status ready">
        <i class="icon ri-time-line"></i>
        <div class="title" id="statusTitle">في انتظار طلب مسح من النظام…</div>
        <div class="sub" id="statusSub">عند ظهور “بدء المسح” سيتم تشغيل الكاميرا تلقائيًا</div>
      </div>
    </div>
  </div>

  <div class="bottombar">
    <button id="btnStart" class="btn primary"><i class="ri-qr-code-line"></i>بدء المسح</button>
    <button id="btnStop" class="btn"><i class="ri-stop-circle-line"></i>إيقاف</button>
    <button id="btnFlip" class="btn"><i class="ri-camera-switch-line"></i>قلب الكاميرا</button>
    <button id="btnTorch" class="btn"><i class="ri-flashlight-line"></i>فلاش</button>
  </div>

  <!-- صوت نجاح (بييب قصير) -->
  <audio id="beep" preload="auto"
    src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA... (short beep trimmed)"></audio>

  <!-- Firebase v9 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { Html5Qrcode } from "https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js";

    // --- Firebase Config (ysk-sales) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCknW-mlzoUtYocy9v1ozxeG4sK6ecMzlc",
      authDomain: "ysk-sales.firebaseapp.com",
      projectId: "ysk-sales",
      storageBucket: "ysk-sales.firebasestorage.app",
      messagingSenderId: "598119419671",
      appId: "1:598119419671:web:774f4c437ffed31f06f152",
      measurementId: "G-VGB0XLKPCL"
    };

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(_) {}
    const auth = getAuth(app);
    const db   = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    // --- UI refs ---
    const statusBox   = document.getElementById('status');
    const statusTitle = document.getElementById('statusTitle');
    const statusSub   = document.getElementById('statusSub');
    const connBadge   = document.getElementById('connBadge').querySelector('span');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const btnFlip  = document.getElementById('btnFlip');
    const btnTorch = document.getElementById('btnTorch');
    const beep     = document.getElementById('beep');

    const readerDiv = document.getElementById('reader');
    let qr = null;
    let currentCameraId = null;
    let torchOn = false;
    let scanning = false;

    function setStatus(mode, title, sub){
      statusBox.className = `status ${mode}`;
      statusTitle.textContent = title || '';
      statusSub.textContent   = sub || '';
    }
    function setConn(text, ok=true){
      const icon = ok ? 'ri-cloud-line' : 'ri-signal-wifi-error-line';
      document.getElementById('connBadge').innerHTML = `<i class="${icon}"></i><span>${text}</span>`;
    }

    // ---- Auth ----
    async function ensureAnon(){
      try{
        const cred = await signInAnonymously(auth);
        return cred.user;
      }catch(e){
        setStatus('error','فشل تسجيل الدخول المجهول','تأكد من تفعيل Anonymous Auth وقواعد Firestore');
        setConn('المصادقة فشلت', false);
        console.error(e);
        throw e;
      }
    }

    // ---- Firestore doc (جلسة ثابتة) ----
    const sessionRef = doc(db, 'scannerSessions', 'fixed');

    // أنشئ الوثيقة إن لم توجد
    async function ensureDoc(){
      await setDoc(sessionRef, { status:'idle', updatedAt: serverTimestamp() }, { merge:true });
    }

    // ---- Scanner ----
    async function startScanner(){
      if (scanning) return;
      setStatus('scanning','وجّه الكاميرا نحو الباركود…','يمكنك تشغيل الفلاش عند الحاجة');

      // تهيئة Html5Qrcode
      if (!qr) qr = new Html5Qrcode('reader', { verbose:false });

      // اختر الكاميرا الخلفية إن أمكن
      const devices = await Html5Qrcode.getCameras();
      const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
      currentCameraId = backCam?.id;

      const config = {
        fps: 12,
        qrbox: { width: Math.min(window.innerWidth, window.innerHeight) * 0.58,
                 height: Math.min(window.innerWidth, window.innerHeight) * 0.58 },
        aspectRatio: window.innerWidth / window.innerHeight,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      };

      await qr.start(
        { deviceId: { exact: currentCameraId }},
        config,
        onScanSuccess,
        () => {}
      );
      scanning = true;
      btnStart.disabled = true; btnStop.disabled = false;
    }

    async function stopScanner(){
      if (!qr || !scanning) return;
      try { await qr.stop(); } catch(_) {}
      scanning = false;
      btnStart.disabled = false; btnStop.disabled = true;
      setStatus('ready','في انتظار طلب مسح من النظام…','اضغط “بدء المسح” أو انتظر إشارة من النظام');
    }

    async function flipCamera(){
      if (!qr) return;
      const devices = await Html5Qrcode.getCameras();
      if (devices.length < 2) return;
      const currentIdx = devices.findIndex(d => d.id === currentCameraId);
      const next = devices[(currentIdx + 1) % devices.length];
      await stopScanner();
      currentCameraId = next.id;
      await startScanner();
    }

    async function toggleTorch(){
      if (!qr || !scanning) return;
      try{
        torchOn = !torchOn;
        await qr.applyVideoConstraints({ advanced: [{ torch: torchOn }]});
        btnTorch.querySelector('i').className = torchOn ? 'ri-flashlight-fill' : 'ri-flashlight-line';
      }catch(_){
        // قد لا تدعم جميع الأجهزة الفلاش
      }
    }

    async function onScanSuccess(text){
      // صوت نجاح
      try { beep.currentTime = 0; await beep.play(); } catch(_){}

      setStatus('success', 'تم المسح بنجاح!', text.length > 64 ? text.slice(0,64)+'…' : text);

      // أوقف المسح لتفادي تكرار النتائج
      await stopScanner();

      // حدّث الجلسة في السحابة
      try{
        await updateDoc(sessionRef, {
          status: 'scanned',
          scannedValue: text,
          scannedAt: serverTimestamp()
        });
      }catch(e){
        console.error('Update session failed', e);
        setStatus('error','فشل تحديث الحالة في السحابة','تحقق من الاتصال أو صلاحيات Firestore');
      }
    }

    // ---- Live listener (لا تكتب داخل onSnapshot) ----
    onSnapshot(sessionRef, snap => {
      const data = snap.data();
      if (!data) return;

      // شارة الاتصال
      setConn('متصل بالسحابة ✓', true);

      if (data.status === 'scanRequested') {
        startScanner();
      } else if (data.status === 'idle' || data.status === 'ready') {
        stopScanner();
      }
    }, err => {
      console.error('Firestore listener error:', err);
      setStatus('error','فشل الاتصال بالنظام','تحقق من الشبكة أو القواعد');
      setConn('انقطاع الاتصال', false);
    });

    // ---- Buttons ----
    btnStart.addEventListener('click', startScanner);
    btnStop .addEventListener('click', stopScanner);
    btnFlip .addEventListener('click', flipCamera);
    btnTorch.addEventListener('click', toggleTorch);

    // ---- Boot ----
    (async () => {
      setConn('جارِ الاتصال…', true);
      await ensureAnon();
      await ensureDoc();
      setStatus('ready','في انتظار طلب مسح من النظام…','يمكنك البدء يدويًا أو من لوحة التحكم');
    })();
  </script>
</body>
</html>
